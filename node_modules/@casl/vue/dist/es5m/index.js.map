{"version":3,"file":"index.js","sources":["../../src/component/can.ts","../../src/plugin.ts"],"sourcesContent":["import Vue, { VNode } from 'vue';\nimport { SubjectType, Generics, AnyAbility, Abilities, IfString, AbilityTuple } from '@casl/ability';\nimport { VueAbility } from '../types';\n\ntype AbilityCanProps<\n  T extends Abilities,\n  Else = IfString<T, { do: T } | { I: T }>\n> = T extends AbilityTuple\n  ? { do: T[0], on: T[1], field?: string } |\n  { I: T[0], a: Extract<T[1], SubjectType>, field?: string } |\n  { I: T[0], an: Extract<T[1], SubjectType>, field?: string } |\n  { I: T[0], this: Exclude<T[1], SubjectType>, field?: string }\n  : Else;\n\nexport type AllCanProps<T extends AnyAbility> = AbilityCanProps<Generics<T>['abilities']> & {\n  not?: boolean,\n  passThrough?: boolean\n};\n\nexport default Vue.extend<AllCanProps<VueAbility>>({\n  name: 'Can',\n  functional: true,\n  props: {\n    I: String,\n    do: String,\n    a: [String, Function],\n    an: [String, Function],\n    this: [String, Function, Object],\n    on: [String, Function, Object],\n    not: Boolean,\n    passThrough: Boolean,\n    field: String\n  },\n  render(h, { props, children, parent, data }): VNode | VNode[] {\n    const mixed = props as any;\n    const [action, field] = (mixed.I || mixed.do || '').split(' ');\n    const subject = mixed.of || mixed.an || mixed.a || mixed.this || mixed.on;\n\n    if (!action) {\n      throw new Error('[Vue Can]: neither `I` nor `do` prop was passed in <Can>');\n    }\n\n    const isAllowed = parent.$can(action, subject, field);\n    const canRender = props.not ? !isAllowed : isAllowed;\n\n    if (!props.passThrough) {\n      return canRender ? children : [];\n    }\n\n    if (!data.scopedSlots || !data.scopedSlots.default) {\n      throw new Error('[Vue Can]: `passThrough` expects default scoped slot to be specified');\n    }\n\n    return data.scopedSlots.default({\n      allowed: canRender,\n      ability: parent.$ability,\n    }) as VNode;\n  }\n});\n","import { VueConstructor } from 'vue';\nimport { VueAbility } from './types';\n\nconst WATCHERS = new WeakMap();\n\nfunction renderingDependencyFor(Vue: VueConstructor, ability: VueAbility) {\n  if (WATCHERS.has(ability)) {\n    return WATCHERS.get(ability);\n  }\n\n  const data = { _touch: true }; // eslint-disable-line no-underscore-dangle\n  const watcher = typeof Vue.observable === 'function'\n    ? Vue.observable(data)\n    : new Vue({ data });\n\n  ability.on('updated', () => {\n    // eslint-disable-next-line no-underscore-dangle\n    watcher._touch = !watcher._touch;\n  });\n  WATCHERS.set(ability, watcher);\n\n  return watcher;\n}\n\nfunction abilityDescriptor(ability?: VueAbility) {\n  if (ability) {\n    return { value: ability };\n  }\n\n  return {\n    get() {\n      throw new Error('Please provide `Ability` instance either in `abilitiesPlugin` or in ComponentOptions');\n    }\n  };\n}\n\nexport function abilitiesPlugin(Vue: VueConstructor, defaultAbility?: VueAbility) {\n  Object.defineProperty(Vue.prototype, '$ability', abilityDescriptor(defaultAbility));\n\n  Vue.mixin({\n    beforeCreate() {\n      const { ability, parent } = this.$options;\n      const localAbility = ability || (parent ? parent.$ability : null);\n\n      if (localAbility) {\n        Object.defineProperty(this, '$ability', { value: localAbility });\n      }\n    },\n\n    methods: {\n      $can(...args: any): boolean {\n        const dep = renderingDependencyFor(Vue, this.$ability);\n        dep._touch = dep._touch; // eslint-disable-line\n        return this.$ability.can(...args);\n      }\n    }\n  });\n}\n"],"names":["Vue","extend","name","functional","props","I","String","do","a","Function","an","this","Object","on","not","Boolean","passThrough","field","render","h","children","parent","data","mixed","split","action","subject","of","Error","isAllowed","$can","canRender","scopedSlots","default","allowed","ability","$ability","WATCHERS","WeakMap","renderingDependencyFor","has","get","_touch","watcher","observable","set","abilitiesPlugin","defaultAbility","defineProperty","prototype","value","mixin","beforeCreate","$options","localAbility","methods","dep","can"],"mappings":"mBAmBA,MAAeA,EAAIC,OAAgC,CACjDC,KAAM,MACNC,YAAY,EACZC,MAAO,CACLC,EAAGC,OACHC,GAAID,OACJE,EAAG,CAACF,OAAQG,UACZC,GAAI,CAACJ,OAAQG,UACbE,KAAM,CAACL,OAAQG,SAAUG,QACzBC,GAAI,CAACP,OAAQG,SAAUG,QACvBE,IAAKC,QACLC,YAAaD,QACbE,MAAOX,QAETY,gBAAOC,SAAKf,IAAAA,MAAOgB,IAAAA,SAAUC,IAAAA,OAAQC,IAAAA,KAC7BC,EAAQnB,KACWmB,EAAMlB,GAAKkB,EAAMhB,IAAM,IAAIiB,MAAM,KAAnDC,OAAQR,OACTS,EAAUH,EAAMI,IAAMJ,EAAMb,IAAMa,EAAMf,GAAKe,EAAMZ,MAAQY,EAAMV,OAElEY,QACG,IAAIG,MAAM,gEAGZC,EAAYR,EAAOS,KAAKL,EAAQC,EAAST,GACzCc,EAAY3B,EAAMU,KAAOe,EAAYA,MAEtCzB,EAAMY,mBACFe,EAAYX,EAAW,OAG3BE,EAAKU,cAAgBV,EAAKU,YAAYC,cACnC,IAAIL,MAAM,+EAGXN,EAAKU,YAAYC,QAAQ,CAC9BC,QAASH,EACTI,QAASd,EAAOe,cCpDhBC,EAAW,IAAIC,QAErB,SAASC,EAAuBvC,EAAqBmC,MAC/CE,EAASG,IAAIL,UACRE,EAASI,IAAIN,OAGhBb,EAAO,CAAEoB,GAAQ,GACjBC,EAAoC,mBAAnB3C,EAAI4C,WACvB5C,EAAI4C,WAAWtB,GACf,IAAItB,EAAI,CAAEsB,KAAAA,WAEda,EAAQtB,GAAG,WAAW,WAEpB8B,EAAQD,GAAUC,EAAQD,KAE5BL,EAASQ,IAAIV,EAASQ,GAEfA,EAeF,SAASG,EAAgB9C,EAAqB+C,GAZrD,IAA2BZ,EAazBvB,OAAOoC,eAAehD,EAAIiD,UAAW,YAbZd,EAa0CY,GAX1D,CAAEG,MAAOf,GAGX,CACLM,qBACQ,IAAIb,MAAM,2FAQpB5B,EAAImD,MAAM,CACRC,8BAC8BzC,KAAK0C,SAAzBlB,IAAAA,QAASd,IAAAA,OACXiC,EAAenB,IAAYd,EAASA,EAAOe,SAAW,MAExDkB,GACF1C,OAAOoC,eAAerC,KAAM,WAAY,CAAEuC,MAAOI,KAIrDC,QAAS,CACPzB,sBACQ0B,EAAMjB,EAAuBvC,EAAKW,KAAKyB,iBAC7CoB,EAAId,EAASc,EAAId,UACLN,UAASqB"}