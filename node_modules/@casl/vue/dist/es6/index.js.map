{"version":3,"file":"index.js","sources":["../../src/component/can.ts","../../src/plugin.ts"],"sourcesContent":["import Vue, { VNode } from 'vue';\nimport { SubjectType, Generics, AnyAbility, Abilities, IfString, AbilityTuple } from '@casl/ability';\nimport { VueAbility } from '../types';\n\ntype AbilityCanProps<\n  T extends Abilities,\n  Else = IfString<T, { do: T } | { I: T }>\n> = T extends AbilityTuple\n  ? { do: T[0], on: T[1], field?: string } |\n  { I: T[0], a: Extract<T[1], SubjectType>, field?: string } |\n  { I: T[0], an: Extract<T[1], SubjectType>, field?: string } |\n  { I: T[0], this: Exclude<T[1], SubjectType>, field?: string }\n  : Else;\n\nexport type AllCanProps<T extends AnyAbility> = AbilityCanProps<Generics<T>['abilities']> & {\n  not?: boolean,\n  passThrough?: boolean\n};\n\nexport default Vue.extend<AllCanProps<VueAbility>>({\n  name: 'Can',\n  functional: true,\n  props: {\n    I: String,\n    do: String,\n    a: [String, Function],\n    an: [String, Function],\n    this: [String, Function, Object],\n    on: [String, Function, Object],\n    not: Boolean,\n    passThrough: Boolean,\n    field: String\n  },\n  render(h, { props, children, parent, data }): VNode | VNode[] {\n    const mixed = props as any;\n    const [action, field] = (mixed.I || mixed.do || '').split(' ');\n    const subject = mixed.of || mixed.an || mixed.a || mixed.this || mixed.on;\n\n    if (!action) {\n      throw new Error('[Vue Can]: neither `I` nor `do` prop was passed in <Can>');\n    }\n\n    const isAllowed = parent.$can(action, subject, field);\n    const canRender = props.not ? !isAllowed : isAllowed;\n\n    if (!props.passThrough) {\n      return canRender ? children : [];\n    }\n\n    if (!data.scopedSlots || !data.scopedSlots.default) {\n      throw new Error('[Vue Can]: `passThrough` expects default scoped slot to be specified');\n    }\n\n    return data.scopedSlots.default({\n      allowed: canRender,\n      ability: parent.$ability,\n    }) as VNode;\n  }\n});\n","import { VueConstructor } from 'vue';\nimport { VueAbility } from './types';\n\nconst WATCHERS = new WeakMap();\n\nfunction renderingDependencyFor(Vue: VueConstructor, ability: VueAbility) {\n  if (WATCHERS.has(ability)) {\n    return WATCHERS.get(ability);\n  }\n\n  const data = { _touch: true }; // eslint-disable-line no-underscore-dangle\n  const watcher = typeof Vue.observable === 'function'\n    ? Vue.observable(data)\n    : new Vue({ data });\n\n  ability.on('updated', () => {\n    // eslint-disable-next-line no-underscore-dangle\n    watcher._touch = !watcher._touch;\n  });\n  WATCHERS.set(ability, watcher);\n\n  return watcher;\n}\n\nfunction abilityDescriptor(ability?: VueAbility) {\n  if (ability) {\n    return { value: ability };\n  }\n\n  return {\n    get() {\n      throw new Error('Please provide `Ability` instance either in `abilitiesPlugin` or in ComponentOptions');\n    }\n  };\n}\n\nexport function abilitiesPlugin(Vue: VueConstructor, defaultAbility?: VueAbility) {\n  Object.defineProperty(Vue.prototype, '$ability', abilityDescriptor(defaultAbility));\n\n  Vue.mixin({\n    beforeCreate() {\n      const { ability, parent } = this.$options;\n      const localAbility = ability || (parent ? parent.$ability : null);\n\n      if (localAbility) {\n        Object.defineProperty(this, '$ability', { value: localAbility });\n      }\n    },\n\n    methods: {\n      $can(...args: any): boolean {\n        const dep = renderingDependencyFor(Vue, this.$ability);\n        dep._touch = dep._touch; // eslint-disable-line\n        return this.$ability.can(...args);\n      }\n    }\n  });\n}\n"],"names":["Vue","extend","name","functional","props","I","String","do","a","Function","an","this","Object","on","not","Boolean","passThrough","field","render","h","children","parent","data","mixed","action","split","subject","of","Error","isAllowed","$can","canRender","scopedSlots","default","allowed","ability","$ability","WATCHERS","WeakMap","abilitiesPlugin","defaultAbility","defineProperty","prototype","value","get","mixin","beforeCreate","$options","localAbility","methods","args","dep","has","_touch","watcher","observable","set","renderingDependencyFor","can"],"mappings":"mBAmBA,MAAeA,EAAIC,OAAgC,CACjDC,KAAM,MACNC,YAAY,EACZC,MAAO,CACLC,EAAGC,OACHC,GAAID,OACJE,EAAG,CAACF,OAAQG,UACZC,GAAI,CAACJ,OAAQG,UACbE,KAAM,CAACL,OAAQG,SAAUG,QACzBC,GAAI,CAACP,OAAQG,SAAUG,QACvBE,IAAKC,QACLC,YAAaD,QACbE,MAAOX,QAETY,OAAOC,GAAGf,MAAEA,EAAFgB,SAASA,EAATC,OAAmBA,EAAnBC,KAA2BA,UAC7BC,EAAQnB,GACPoB,EAAQP,IAAUM,EAAMlB,GAAKkB,EAAMhB,IAAM,IAAIkB,MAAM,KACpDC,EAAUH,EAAMI,IAAMJ,EAAMb,IAAMa,EAAMf,GAAKe,EAAMZ,MAAQY,EAAMV,OAElEW,QACG,IAAII,MAAM,kEAGZC,EAAYR,EAAOS,KAAKN,EAAQE,EAAST,GACzCc,EAAY3B,EAAMU,KAAOe,EAAYA,MAEtCzB,EAAMY,mBACFe,EAAYX,EAAW,OAG3BE,EAAKU,cAAgBV,EAAKU,YAAYC,cACnC,IAAIL,MAAM,+EAGXN,EAAKU,YAAYC,QAAQ,CAC9BC,QAASH,EACTI,QAASd,EAAOe,cCpDtB,MAAMC,EAAW,IAAIC,QAiCd,SAASC,EAAgBvC,EAAqBwC,GAZrD,IAA2BL,EAazBvB,OAAO6B,eAAezC,EAAI0C,UAAW,YAbZP,EAa0CK,GAX1D,CAAEG,MAAOR,GAGX,CACLS,YACQ,IAAIhB,MAAM,2FAQpB5B,EAAI6C,MAAM,CACRC,qBACQX,QAAEA,EAAFd,OAAWA,GAAWV,KAAKoC,SAC3BC,EAAeb,IAAYd,EAASA,EAAOe,SAAW,MAExDY,GACFpC,OAAO6B,eAAe9B,KAAM,WAAY,CAAEgC,MAAOK,KAIrDC,QAAS,CACPnB,QAAQoB,SACAC,EA9Cd,SAAgCnD,EAAqBmC,MAC/CE,EAASe,IAAIjB,UACRE,EAASO,IAAIT,SAGhBb,EAAO,CAAE+B,GAAQ,GACjBC,EAAoC,mBAAnBtD,EAAIuD,WACvBvD,EAAIuD,WAAWjC,GACf,IAAItB,EAAI,CAAEsB,KAAAA,WAEda,EAAQtB,GAAG,UAAW,KAEpByC,EAAQD,GAAUC,EAAQD,IAE5BhB,EAASmB,IAAIrB,EAASmB,GAEfA,EA8BWG,CAAuBzD,EAAKW,KAAKyB,iBAC7Ce,EAAIE,EAASF,EAAIE,EACV1C,KAAKyB,SAASsB,OAAOR"}