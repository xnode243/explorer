{"ast":null,"code":"import \"core-js/modules/es.regexp.exec.js\";\nimport \"core-js/modules/es.string.split.js\";\nimport \"core-js/modules/es.array.map.js\";\nimport \"core-js/modules/es.array.from.js\";\nimport \"core-js/modules/es.string.iterator.js\";\nimport \"core-js/modules/es.string.repeat.js\";\nimport \"core-js/modules/es.number.constructor.js\";\nimport \"core-js/modules/es.object.to-string.js\";\nimport \"core-js/modules/web.dom-collections.for-each.js\";\nimport \"core-js/modules/es.array.find.js\";\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\nimport { BRow, BCol, VBTooltip, BCard, BAlert, BCardTitle, BFormCheckbox, BBadge } from 'bootstrap-vue';\nimport { getLocalChains, timeIn, toDay } from '@/libs/utils';\nimport { fromBech32, toBase64 } from '@cosmjs/encoding';\nexport default {\n  name: 'Blocks',\n  components: {\n    BBadge: BBadge,\n    BRow: BRow,\n    BCol: BCol,\n    BCard: BCard,\n    BAlert: BAlert,\n    BCardTitle: BCardTitle,\n    BFormCheckbox: BFormCheckbox\n  },\n  directives: {\n    'b-tooltip': VBTooltip\n  },\n  props: {\n    chain: {\n      type: String,\n      default: null\n    },\n    validators: {\n      type: Array,\n      default: function _default() {\n        return [];\n      }\n    }\n  },\n  data: function data() {\n    var chains = getLocalChains();\n    var pinned = localStorage.getItem('pinned') ? localStorage.getItem('pinned').split(',') : '';\n    return {\n      pinned: pinned,\n      config: chains[this.chain],\n      missing: {},\n      blocks: Array.from('0'.repeat(50)).map(function (x) {\n        return {\n          sigs: {},\n          height: Number(x)\n        };\n      }),\n      syncing: false,\n      latestTime: '',\n      height: '-'\n    };\n  },\n  computed: {\n    uptime: function uptime() {\n      var vals = this.validators;\n      return vals;\n    }\n  },\n  created: function created() {\n    var _this = this;\n\n    this.initBlocks();\n    this.$http.getSlashingSigningInfo(this.config).then(function (res) {\n      if (res.info) {\n        res.info.forEach(function (x) {\n          if (x.address) {\n            var addr = toBase64(fromBech32(x.address).data);\n            _this.missing[addr] = x;\n          }\n        });\n      }\n    });\n  },\n  beforeDestroy: function beforeDestroy() {\n    this.blocks = []; // clear running tasks if it is not finish\n\n    this.syncing = false;\n    clearInterval(this.timer);\n  },\n  methods: {\n    pinValidator: function pinValidator() {\n      localStorage.setItem('pinned', this.pinned);\n    },\n    initBlocks: function initBlocks() {\n      var _this2 = this;\n\n      this.$http.getLatestBlock(this.config).then(function (d) {\n        var height = d.block.last_commit.height;\n        _this2.height = height;\n\n        if (timeIn(d.block.header.time, 3, 'm')) {\n          _this2.syncing = true;\n        } else {\n          _this2.syncing = false;\n        }\n\n        _this2.latestTime = toDay(d.block.header.time, 'long');\n        var blocks = []; // update height\n\n        var promise = Promise.resolve();\n\n        var _loop = function _loop(i) {\n          blocks.unshift({\n            sigs: {},\n            height: i > 0 ? i : 0\n          });\n\n          if (i > height - 48 && i > 0) {\n            promise = promise.then(function () {\n              return new Promise(function (resolve) {\n                _this2.fetch_status(i, resolve);\n              });\n            });\n          }\n        };\n\n        for (var i = height - 1; i > height - 50; i -= 1) {\n          _loop(i);\n        }\n\n        var sigs = _this2.initColor();\n\n        d.block.last_commit.signatures.forEach(function (x) {\n          if (x.validator_address) sigs[x.validator_address] = 'bg-success';\n        });\n        blocks.push({\n          sigs: sigs,\n          height: height\n        });\n        _this2.blocks = blocks;\n        _this2.timer = setInterval(_this2.fetch_latest, 6000);\n      });\n    },\n    initColor: function initColor() {\n      var sigs = {};\n      this.validators.forEach(function (x) {\n        sigs[x.address] = 'bg-danger';\n      });\n      return sigs;\n    },\n    fetch_status: function fetch_status(height, resolve) {\n      var _this3 = this;\n\n      var block = this.blocks.find(function (b) {\n        return b.height === height;\n      });\n\n      if (block) {\n        this.$http.getBlockByHeight(height, this.config).then(function (res) {\n          resolve();\n\n          var sigs = _this3.initColor();\n\n          res.block.last_commit.signatures.forEach(function (x) {\n            if (x.validator_address) sigs[x.validator_address] = 'bg-success';\n          });\n\n          _this3.$set(block, 'sigs', sigs);\n        });\n      }\n    },\n    fetch_latest: function fetch_latest() {\n      var _this4 = this;\n\n      this.$http.getLatestBlock(this.config).then(function (res) {\n        var sigs = _this4.initColor();\n\n        res.block.last_commit.signatures.forEach(function (x) {\n          if (x.validator_address) sigs[x.validator_address] = 'bg-success';\n        });\n        _this4.height = res.block.last_commit.height;\n\n        var block = _this4.blocks.find(function (b) {\n          return b.height === res.block.last_commit.height;\n        });\n\n        if (typeof block === 'undefined') {\n          // mei\n          // this.$set(block, 0, typeof sigs !== 'undefined')\n          if (_this4.blocks.length >= 50) _this4.blocks.shift();\n\n          _this4.blocks.push({\n            sigs: sigs,\n            height: res.block.last_commit.height\n          });\n        }\n      });\n    }\n  }\n};","map":null,"metadata":{},"sourceType":"module"}